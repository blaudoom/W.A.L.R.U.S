package fi.blaudoom.pentestgui.service.project;

import fi.blaudoom.pentestgui.dao.NmapScanRepository;
import fi.blaudoom.pentestgui.dao.TargetRepository;
import fi.blaudoom.pentestgui.model.Target;
import fi.blaudoom.pentestgui.model.TargetService;
import fi.blaudoom.pentestgui.service.project.dto.*;
import org.modelmapper.ModelMapper;
import org.springframework.data.crossstore.ChangeSetPersister;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
public class TargetAccessServiceImpl implements TargetAccessService {

    private final TargetRepository targetRepository;
    private final ModelMapper modelMapper;

    private final NmapScanRepository nmapScanRepository;

    public TargetAccessServiceImpl(TargetRepository targetRepository, ModelMapper modelMapper, NmapScanRepository nmapScanRepository) {
        this.targetRepository = targetRepository;
        this.modelMapper = modelMapper;
        this.nmapScanRepository = nmapScanRepository;
    }

    /*TODO:
     *  Better DTO conversion. */
    @Override
    public CumulativeTargetDto getTargetById(Long id) throws ChangeSetPersister.NotFoundException {
        Target target = targetRepository.findById(id).orElseThrow(ChangeSetPersister.NotFoundException::new);
        TargetDto targetDto = modelMapper.map(target, TargetDto.class);
        CumulativeTargetDto dto = new CumulativeTargetDto();
        Map<Integer, CumulativeTargetServiceDto> cumulativeTargetServiceDtoMap = new HashMap<>();

        dto.setHostname(targetDto.getHostname());
        dto.setDescription(targetDto.getDescription());
        dto.setHostnames(targetDto.getHostnames());
        dto.setId(targetDto.getId());
        dto.setProject(targetDto.getProject());
        dto.setIpAddress(targetDto.getIpAddress());
        dto.setState(targetDto.getState());
        dto.setInfo(targetDto.getInfo());

        for (TargetService service : target.getServices().stream().sorted().toList()) {
            if (cumulativeTargetServiceDtoMap.containsKey(service.getPort())) {
                CumulativeTargetServiceDto cumulativeTargetServiceDto = cumulativeTargetServiceDtoMap.get(service.getPort());
                cumulativeTargetServiceDto.getSeenOnScanId().add(new SeenOnScanDto(service.getSeenOnScan().getId(),service.getSeenOnScan().getProjectRunOrdinal()));
                cumulativeTargetServiceDto.getTargetServiceIterations().add(modelMapper.map(service, TargetServiceDto.class));
                if (cumulativeTargetServiceDto.getCpe() == null && service.getCpe() != null) {
                    cumulativeTargetServiceDto.setCpe(service.getCpe());
                }
                if (cumulativeTargetServiceDto.getServicefp() == null && service.getServicefp() != null) {
                    cumulativeTargetServiceDto.setServicefp(service.getServicefp());
                }
            } else {
                CumulativeTargetServiceDto cumulativeTargetServiceDto = new CumulativeTargetServiceDto();
                //Make a  method that replaces modelmapper call with a method call that only maps the fields we need
                TargetServiceDto tempDto = modelMapper.map(service, TargetServiceDto.class);
                cumulativeTargetServiceDto.setCpe(service.getCpe());
                cumulativeTargetServiceDto.setName(service.getName());
                if(cumulativeTargetServiceDto.getLatest() == null || cumulativeTargetServiceDto.getLatest().before(service.getCreated())) {
                    cumulativeTargetServiceDto.setServiceNotes(tempDto.getServiceNotes());
                    cumulativeTargetServiceDto.setScriptResults(tempDto.getScriptResults());
                }
                cumulativeTargetServiceDto.setPort(tempDto.getPort());
                cumulativeTargetServiceDto.setProduct(tempDto.getProduct());
                cumulativeTargetServiceDto.setProtocol(tempDto.getProtocol());
                cumulativeTargetServiceDto.setServicefp(tempDto.getServicefp());
                cumulativeTargetServiceDto.setVersion(tempDto.getVersion());
                cumulativeTargetServiceDto.setId(tempDto.getId());
                cumulativeTargetServiceDto.setState(tempDto.getState());
                tempDto.setSeenOnScanDto(new SeenOnScanDto(service.getSeenOnScan().getId(), service.getSeenOnScan().getProjectRunOrdinal()));
                cumulativeTargetServiceDto.getTargetServiceIterations().add(tempDto);

                cumulativeTargetServiceDto.getSeenOnScanId().add(new SeenOnScanDto(service.getSeenOnScan().getId(), service.getSeenOnScan().getProjectRunOrdinal()));
                cumulativeTargetServiceDtoMap.put(service.getPort(), cumulativeTargetServiceDto);
                cumulativeTargetServiceDto.setLatest(service.getCreated());
            }
        }
        dto.setServices(new ArrayList<>(cumulativeTargetServiceDtoMap.values()));
        return dto;
    }

    @Override
    public NmapScanDto getNmapScanById(Long id) throws ChangeSetPersister.NotFoundException {
        return modelMapper.map(nmapScanRepository.findById(id).orElseThrow(ChangeSetPersister.NotFoundException::new), NmapScanDto.class);
    }
}
